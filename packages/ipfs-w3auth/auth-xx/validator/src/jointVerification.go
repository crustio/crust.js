package main

import (
	"encoding/base64"
	"strconv"
	"time"

	"github.com/pkg/errors"
	"gitlab.com/xx_network/crypto/signature/rsa"
)

const (
	UDPubkeyEncoded = `-----BEGIN RSA PRIVATE KEY-----
MIIJKQIBAAKCAgEAtr55qU5p/QiNjQf/dGfazkM6tbU6Rdj0mcmEzKIF+X2TO3dH
rao+azGSjyhfNKm/dtDOcLinPXxk+DcivAP6sUpWFYmzlCx9iE3PDQgCe7Wxb/I5
Rhm1GUdABJX1IyDvkANKZlggwTqNu8WscRSX/EJreGpCAKc2sBRkoczm8OvYuIxV
E8l3Hb5Z8YcYqjvOYvqWNt2LQP/InHxpZG6Is/FBph+vVhTs3uwVW8BD56yTncwf
mToC9RFYzG08OmjIWh8YRqtHGyhv8rGt6GIcF1TVmqT1jW2XCsnVLdTLEamT0WNK
iB0KUPHuRv0RhVmPJyKCR3MGAWY1cBcrrqED4mQputZ7qV6aW6FqtoPRnuqz+br2
q9l+miswqZTxvvumv0Q0j1OAFA5uMlnjzxrFzzX5F5BijQ7nFJZrkwvU5Qe8vgqh
gaoZz8sKjVJUYOesru1nGwgtihzk4RByBMe52iehRhUNLXTidSwGAh9cuTPLf043
OVOEzCiZHLJZD9WpindvcXyPqcnvGERyodD/K1R5mbPG0dPLuJltMumQJakZdbzu
CAnywXUMhuMgPTkSyVvJEDAn9psUYYFzNcgpWFQbrgovG89IhohM0xog5mmppVvL
9NVsubtw2PK9N2A2uejCRXFEvt6jCxXCDvuGr3TV0WaUWbWnLUbzMP9dSecCAwEA
AQKCAgBjAKRGvg2boPOW8TtLJCydTDzVTn5octZpLoy8lBaqiIaoU8HIaw/v4OZm
mleh30i0JQGCffdUzzygYLZ3p6w8OmqStoxMfSHxIz5F8A3wWYnsfQzcVncPX9Nl
6Jvq0SAYJEA9XAc6x+8bSEdY5/BDIPS6Qs7JLc3p7NJr+ecvpIY/zP8WfjIDMinm
OOt65nW0l8+jn7iemTRk2t36JAv5eH25czb5atK9HqefknT3YT6D4Z9I0u3hOOmj
rpZPio7ojCoJtycJpomnsOznladkWHh0lGPXoASROrE8aCkvw3AqoyEwxpLdMYSG
fvnsBY4RhJeR/9XEEkxnEpZ+wAqqwvCWAh9ipTX/dnRH26R7sCxlM+dqMRVmDYCY
pI7MNhtmjGZDDTmhk/tMYIapPRuTj4RLMyaaZ93m9+oMSRVGQp0JD1okiA1etzBS
yMu4jsfalUTe2gSrxMZ/O/IYfW3fSHe6BM7mmNskQoLawQPwfB2jWjeymTiF+F4D
32dqNLx4NkOVozqo42Dv3R4pzli+dk6UPL7pCBF8Fiy1Jk56oDYKaksjwnQuZ+8Q
wnsIuH/Vh+Pe7+ULWEKYp2RGGzB7cuUfFkFu660qMQ64paQAsSxAOg82fjNLPNZk
3bfBRz8ft1Ln7TEAUJimx/GakSJDa2iHvoOlcNtbwFYSbDGv6QKCAQEA8rO0tba3
uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn
6Onq6+zt7u/w8fLz9PX29/j5+vv8/f4AAQIDBAUGBwgJCgsMDQ4PEBESExQVFhcY
GRobHB0eHyAhIiMkJSYnKCkqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdI
SUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4
eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6Slpqeo
qaqrrK2ur7CxuwKCAQEAwMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g
4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+AAECAwQFBgcICQoLDA0ODxAR
EhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BB
QkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3Bx
cnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6Ch
oqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/xQKCAQEAj/vM2YDsvcpx3a67
Ys6frFO/kJ1EsIGONaFyfyaSY3AXg1RhCHRFUfllNkLqVicz20cYJMw4CRW9KPoG
rhnq958K2+iP+8zZgOy9ynFFz1NCNsBEMyexNSQYoiYVCZMXBfqEB/brdPjn3GXp
2M1W2sm+R8u6rzi8q6AprZyRGp6NgguPfnL8gG9j7XFgVN5iUUXPU0I2wEQzJ7E1
JBiiJhUJkxcF+oQH9ut0+OfcZenYzVbayb5Hy7qvOLyroCmtnJEano2CC49+cvyA
b2PtcWBU3mJRRc9TQjbARDMnsTUkGKImFQmTFwX6hAf263T459xl6djNVtrJvkfL
uq84wQKCAQAErrBEgSsswP2nqT16JCW59qCiNnMdHrLvmZsvbBYXq+iSlChlDxCk
4YuNIV4ICZ3ahIYaVwECltN9fxNP+fuJlHywBhD5LIKNdaj/CfIle4ZuofgC6x50
f2ea8PvkF214YJPp9N0QZnFZjOLt1glfalKF2+bPAlhjS37U38f7UVxEd83YwPRK
VT1wxtG57UNONmm/yrLmPEcvYrjDq981QChbsbyk2C45IVSqtZ3RJzIaTaOulsog
KxNGnKePwxkkDD+VoIi8Eh0FOI6ZgbULFf4xh5J6rgQO9yqAi3Om/QfwI3mEbJ/2
AOkccn1lmO754hVrdl6R5/LbDmRvV4rhAoIBAQDL7iY6QlVOgf8GtzBq3WLHQz6g
oDblrzcnlEkBRvyWUhBDVCYoEBL3xI0scKQhJCBXLNK1b11j6RIud/3b30qVEE4L
LLdObT0vEK01As6ERIwEtUwMqOuEwHHF+/nrPphuM1pXO94+D5yf59Y6zJX7SH4A
bzz+NnFFl/4kLH/WkjQb7yIiw4TlCHsUHoFMV2/YY+WyBEN7Qf8KWddZg9BlK3Dq
28+b3QHbLezNzVevpw4QU0Sr9Mh5jOZEkb9pfedHBFo62K1AC5Qp+lr2UKgjvJCZ
PcwjaBBRfZBtdBsapXNHk33BqOPnIC1/vCFoiJ2YZ6lRgR08vwZWzsxdL7JK
-----END RSA PRIVATE KEY-----
`
)

func jointVerify(data *DataForVerify) error {
	// UDPubkey
	UDPubkey, err := rsa.LoadPrivateKeyFromPem([]byte(UDPubkeyEncoded))
	if err != nil {
		return err
	}

	// Hash username
	userNameHash := hashUsername(data.UserName)

	// Get userPubKey
	userPubKeyTrue, err := base64.StdEncoding.DecodeString(data.UserPubKey)
	if err != nil {
		return err
	}

	userPubKey, err := rsa.LoadPublicKeyFromPem(userPubKeyTrue)
	if err != nil {
		return err
	}

	// Get verifSig
	verifSig, err := base64.StdEncoding.DecodeString(data.VerifSig)
	if err != nil {
		return err
	}

	// Verify user pubkey and name
	if err := verifyVerification(UDPubkey.GetPublic(), userNameHash, userPubKey, verifSig); err != nil {
		return errors.WithMessage(err, "Failed to verify the Verification Signature")
	}

	// Get fileHash
	fileHash, err := base64.StdEncoding.DecodeString(data.FileHash)
	if err != nil {
		return err
	}

	// Get uploadSig
	uploadSig, err := base64.StdEncoding.DecodeString(data.UploadSig)
	if err != nil {
		return err
	}

	// Get timestamp
	timestampInt64, err := strconv.ParseInt(data.Timestamp, 10, 64)
	if err != nil {
		return err
	}
	timestamp := time.Unix(0, timestampInt64)

	if err := verifyUpload(userPubKey, time.Now(), timestamp, fileHash, uploadSig); err != nil {
		return errors.WithMessage(err, "Failed to verify the Upload Signature")
	}

	return nil
}
